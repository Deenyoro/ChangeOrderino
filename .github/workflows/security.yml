name: Security Scanning

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Add explicit permissions for the entire workflow
# Note: CodeQL requires GitHub Advanced Security for private repositories
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  basic-security-scan:
    name: Basic Security Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'  # Don't fail the build on vulnerabilities

    - name: Check for secrets in code
      run: |
        echo "Checking for potential secrets..."
        grep -r -i "password\|secret\|key\|token" --include="*.py" --include="*.js" --include="*.ts" --include="*.json" . || echo "No obvious secrets found"

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript' ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Initialize CodeQL
      id: init-codeql
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
      continue-on-error: true

    - name: Autobuild
      if: steps.init-codeql.outcome == 'success'
      uses: github/codeql-action/autobuild@v4
      continue-on-error: true

    - name: Perform CodeQL Analysis
      if: steps.init-codeql.outcome == 'success'
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{ matrix.language }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: CodeQL Status Check
      run: |
        if [ "${{ steps.init-codeql.outcome }}" != "success" ]; then
          echo "‚ö†Ô∏è  CodeQL analysis skipped - GitHub Advanced Security may not be enabled for this private repository"
          echo "To enable CodeQL scanning on private repositories, GitHub Advanced Security must be enabled."
          echo "For public repositories, CodeQL runs automatically."
          echo "Basic security scanning (Trivy) completed successfully."
        else
          echo "‚úÖ CodeQL analysis completed successfully"
        fi

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [basic-security-scan, codeql-analysis]
    if: always()

    steps:
    - name: Security Scan Summary
      run: |
        echo "## üîí Security Scanning Results"
        echo ""

        if [ "${{ needs.basic-security-scan.result }}" == "success" ]; then
          echo "‚úÖ **Basic Security Scan**: PASSED"
          echo "   - Trivy vulnerability scanning completed"
          echo "   - Secret detection completed"
        else
          echo "‚ùå **Basic Security Scan**: FAILED"
        fi

        echo ""

        # Check CodeQL results (may be skipped for private repos without Advanced Security)
        if [ "${{ needs.codeql-analysis.result }}" == "success" ]; then
          echo "‚úÖ **CodeQL Analysis**: PASSED"
          echo "   - Static code analysis completed for Python and JavaScript"
        elif [ "${{ needs.codeql-analysis.result }}" == "failure" ]; then
          echo "‚ö†Ô∏è  **CodeQL Analysis**: SKIPPED (likely due to GitHub Advanced Security not enabled)"
          echo "   - CodeQL requires GitHub Advanced Security for private repositories"
          echo "   - Basic security scanning still provides valuable protection"
        else
          echo "‚ùå **CodeQL Analysis**: FAILED"
        fi

        echo ""
        echo "**Overall Security Status**: Basic security scanning operational ‚úÖ"
